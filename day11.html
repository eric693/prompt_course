<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Day 11 — 旅遊平台客服 Agent | Prompt Mastery</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=IBM+Plex+Mono:wght@300;400;500;600&family=Noto+Serif+TC:wght@300;400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #111009;
    --surface: #1c1a15;
    --surface2: #232018;
    --border: #2e2b22;
    --ink: #f0ece4;
    --ink-dim: #8a8375;
    --ink-faint: #4a4740;
    --accent: #d4521f;
    --accent-warm: #e8935a;
    --gold: #c9a84c;
    --green: #4a7c59;
    --green-light: #7ab893;
    --blue: #3a6080;
    --blue-light: #6aabcc;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  html { scroll-behavior: smooth; }
  body { background: var(--bg); color: var(--ink); font-family: 'IBM Plex Mono', monospace; line-height: 1.6; overflow-x: hidden; }

  body::after { content: ''; position: fixed; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E"); pointer-events: none; z-index: 9999; }

  /* NAV */
  .topnav { position: sticky; top: 0; z-index: 200; background: var(--bg); border-bottom: 1px solid var(--border); padding: 0 48px; display: flex; align-items: center; justify-content: space-between; height: 52px; }
  .nav-back { display: flex; align-items: center; gap: 10px; text-decoration: none; color: var(--ink-dim); font-size: 11px; letter-spacing: 0.15em; text-transform: uppercase; transition: color 0.2s; }
  .nav-back:hover { color: var(--ink); }
  .nav-center { font-family: 'Playfair Display', serif; font-size: 14px; font-weight: 700; letter-spacing: 0.08em; color: var(--ink-dim); }
  .nav-progress { display: flex; align-items: center; gap: 10px; font-size: 11px; color: var(--ink-dim); letter-spacing: 0.1em; }
  .nav-progress-bar { width: 120px; height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .nav-progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.4s ease; }

  /* HERO */
  .lesson-hero { border-bottom: 1px solid var(--border); padding: 72px 48px 64px; position: relative; overflow: hidden; }
  .lesson-hero::before { content: '11'; position: absolute; right: -16px; bottom: -48px; font-family: 'Playfair Display', serif; font-size: 280px; font-weight: 900; color: var(--surface2); line-height: 1; pointer-events: none; }
  .lesson-meta { display: flex; align-items: center; gap: 20px; margin-bottom: 28px; }
  .meta-day { background: var(--accent); color: var(--ink); padding: 5px 14px; font-size: 11px; letter-spacing: 0.2em; text-transform: uppercase; font-weight: 600; }
  .meta-badge { background: var(--surface2); border: 1px solid var(--border); color: var(--gold); padding: 5px 14px; font-size: 11px; letter-spacing: 0.12em; }
  .meta-time { font-size: 11px; letter-spacing: 0.15em; color: var(--ink-dim); }
  .meta-time::before { content: '—  '; }
  .lesson-title { font-family: 'Playfair Display', serif; font-size: clamp(34px, 4.5vw, 68px); font-weight: 900; line-height: 0.95; letter-spacing: -0.02em; margin-bottom: 28px; position: relative; z-index: 1; max-width: 760px; }
  .lesson-title em { font-style: italic; color: var(--accent-warm); }
  .lesson-lead { font-family: 'Noto Serif TC', serif; font-size: 16px; line-height: 1.9; color: var(--ink-dim); max-width: 620px; position: relative; z-index: 1; margin-bottom: 36px; }
  .lesson-objectives { display: flex; gap: 10px; flex-wrap: wrap; position: relative; z-index: 1; }
  .objective-tag { border: 1px solid var(--border); padding: 6px 16px; font-size: 11px; letter-spacing: 0.1em; color: var(--ink-dim); }
  .objective-tag.highlight { border-color: var(--accent); color: var(--accent-warm); }

  /* LAYOUT */
  .lesson-body { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 300px; border-left: 1px solid var(--border); border-right: 1px solid var(--border); }
  .lesson-main { border-right: 1px solid var(--border); }
  .lesson-sidebar { padding: 36px 24px; position: sticky; top: 52px; height: calc(100vh - 52px); overflow-y: auto; }

  /* SECTIONS */
  .lesson-section { border-bottom: 1px solid var(--border); padding: 48px; opacity: 0; transform: translateY(16px); transition: opacity 0.5s ease, transform 0.5s ease; }
  .lesson-section.visible { opacity: 1; transform: translateY(0); }
  .section-eyebrow { font-size: 10px; letter-spacing: 0.25em; text-transform: uppercase; color: var(--accent); margin-bottom: 16px; display: flex; align-items: center; gap: 12px; }
  .section-eyebrow::before { content: ''; display: block; width: 24px; height: 1px; background: var(--accent); }
  .section-heading { font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 700; line-height: 1.2; margin-bottom: 20px; }
  .section-body { font-family: 'Noto Serif TC', serif; font-size: 14px; line-height: 1.95; color: var(--ink-dim); }
  .section-body p { margin-bottom: 14px; }
  .section-body p:last-child { margin-bottom: 0; }
  .section-body strong { color: var(--ink); font-weight: 700; }

  /* STEP SYSTEM */
  .step-builder { display: flex; flex-direction: column; gap: 0; margin: 28px 0; }

  .step-block { border: 1px solid var(--border); background: var(--surface); overflow: hidden; }
  .step-block + .step-block { border-top: none; }

  .step-header { padding: 18px 24px; display: flex; align-items: center; gap: 16px; cursor: pointer; transition: background 0.15s; }
  .step-header:hover { background: var(--surface2); }

  .step-num { width: 32px; height: 32px; border: 1px solid var(--accent); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; color: var(--accent); flex-shrink: 0; }
  .step-num.done { background: var(--accent); color: var(--ink); border-color: var(--accent); }

  .step-title-wrap { flex: 1; }
  .step-label { font-size: 10px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--ink-faint); margin-bottom: 3px; }
  .step-title { font-size: 14px; font-weight: 600; color: var(--ink); }

  .step-toggle { font-size: 16px; color: var(--ink-faint); transition: transform 0.2s; }
  .step-block.open .step-toggle { transform: rotate(180deg); }

  .step-content { display: none; border-top: 1px solid var(--border); }
  .step-block.open .step-content { display: block; }

  .step-inner { padding: 28px; }
  .step-desc { font-family: 'Noto Serif TC', serif; font-size: 13px; line-height: 1.8; color: var(--ink-dim); margin-bottom: 20px; }
  .step-desc strong { color: var(--ink); }

  /* PROMPT BLOCK */
  .prompt-block { background: var(--bg); border: 1px solid var(--border); border-left: 3px solid var(--accent); margin: 0 0 16px; }
  .prompt-block-header { padding: 12px 18px; border-bottom: 1px solid var(--border); background: var(--surface); display: flex; justify-content: space-between; align-items: center; }
  .prompt-block-label { font-size: 10px; letter-spacing: 0.18em; text-transform: uppercase; color: var(--accent); }
  .copy-btn { background: none; border: 1px solid var(--border); color: var(--ink-dim); padding: 4px 12px; font-family: 'IBM Plex Mono', monospace; font-size: 10px; letter-spacing: 0.1em; cursor: pointer; transition: all 0.15s; text-transform: uppercase; }
  .copy-btn:hover { border-color: var(--accent); color: var(--accent-warm); }
  .copy-btn.copied { border-color: var(--green); color: var(--green-light); }
  .prompt-code { padding: 18px 20px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; line-height: 1.85; color: var(--accent-warm); white-space: pre-wrap; word-break: break-word; }
  .pc { color: var(--ink-faint); }
  .pk { color: var(--gold); }
  .pv { color: var(--green-light); }
  .pb { color: var(--blue-light); }

  /* TEST RESULT BOX */
  .test-result { background: var(--surface2); border: 1px solid var(--border); border-left: 3px solid var(--green); padding: 18px 22px; margin: 12px 0; }
  .test-label { font-size: 10px; letter-spacing: 0.18em; text-transform: uppercase; color: var(--green-light); margin-bottom: 10px; }
  .test-text { font-family: 'Noto Serif TC', serif; font-size: 13px; line-height: 1.8; color: var(--ink); }
  .test-text .role-tag { color: var(--blue-light); font-family: 'IBM Plex Mono', monospace; font-size: 11px; margin-right: 6px; }

  /* WHY BOX */
  .why-box { background: var(--surface2); border: 1px solid var(--border); border-top: 2px solid var(--gold); padding: 20px 24px; margin: 16px 0 0; }
  .why-label { font-size: 10px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--gold); margin-bottom: 8px; }
  .why-text { font-size: 12px; line-height: 1.7; color: var(--ink-dim); font-family: 'Noto Serif TC', serif; }

  /* INTENT MAP */
  .intent-map { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); margin: 16px 0; }
  .intent-card { background: var(--surface); padding: 18px 20px; }
  .intent-card:hover { background: var(--surface2); }
  .intent-arrow { font-size: 10px; letter-spacing: 0.12em; color: var(--accent); margin-bottom: 6px; font-family: 'IBM Plex Mono', monospace; }
  .intent-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
  .intent-keywords { font-size: 11px; color: var(--ink-faint); line-height: 1.6; }

  /* FLOW DIAGRAM */
  .flow-diagram { display: flex; flex-direction: column; gap: 0; margin: 20px 0; }
  .flow-row { display: flex; align-items: stretch; }
  .flow-node { flex: 1; background: var(--surface); border: 1px solid var(--border); padding: 14px 18px; position: relative; }
  .flow-node.trigger { border-color: var(--accent); background: rgba(212,82,31,0.08); }
  .flow-node.process { border-color: var(--gold); background: rgba(201,168,76,0.08); }
  .flow-node.output { border-color: var(--green); background: rgba(74,124,89,0.08); }
  .flow-node.condition { border-color: var(--blue-light); background: rgba(58,96,128,0.12); }
  .flow-node-label { font-size: 9px; letter-spacing: 0.18em; text-transform: uppercase; color: var(--ink-faint); margin-bottom: 4px; }
  .flow-node-text { font-size: 12px; line-height: 1.5; color: var(--ink); }
  .flow-arrow { width: 40px; display: flex; align-items: center; justify-content: center; color: var(--ink-faint); font-size: 16px; flex-shrink: 0; }
  .flow-down { height: 28px; display: flex; align-items: center; justify-content: center; color: var(--ink-faint); font-size: 14px; }

  /* LIVE SIMULATOR */
  .simulator { background: var(--surface); border: 1px solid var(--border); overflow: hidden; margin: 24px 0; }
  .sim-header { padding: 16px 22px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; background: var(--surface2); }
  .sim-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--green); box-shadow: 0 0 6px var(--green); }
  .sim-title { font-size: 12px; letter-spacing: 0.12em; color: var(--ink-dim); }
  .sim-stage { font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase; padding: 3px 10px; border: 1px solid var(--border); color: var(--ink-faint); margin-left: auto; }
  .sim-stage.active { border-color: var(--green); color: var(--green-light); }

  .chat-window { height: 320px; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
  .chat-msg { display: flex; gap: 10px; align-items: flex-start; }
  .chat-msg.user { flex-direction: row-reverse; }
  .chat-avatar { width: 28px; height: 28px; background: var(--surface2); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 10px; flex-shrink: 0; color: var(--ink-dim); letter-spacing: 0; }
  .chat-avatar.agent { border-color: var(--accent); color: var(--accent); }
  .chat-bubble { max-width: 75%; background: var(--surface); border: 1px solid var(--border); padding: 10px 14px; font-size: 13px; line-height: 1.6; font-family: 'Noto Serif TC', serif; color: var(--ink); }
  .chat-bubble.user { background: var(--surface2); border-color: var(--border); color: var(--ink-dim); }
  .chat-bubble.agent { border-left: 2px solid var(--accent); }
  .chat-tag { font-size: 9px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--accent); margin-bottom: 4px; }
  .chat-tag.intent { color: var(--blue-light); }
  .chat-tag.policy { color: var(--gold); }
  .chat-tag.escalate { color: #c04040; }

  .sim-input-row { border-top: 1px solid var(--border); padding: 14px 20px; display: flex; gap: 10px; }
  .sim-scenarios { display: flex; gap: 6px; flex-wrap: wrap; padding: 12px 20px; border-top: 1px solid var(--border); background: var(--bg); }
  .scenario-btn { background: var(--surface); border: 1px solid var(--border); color: var(--ink-dim); padding: 6px 12px; font-size: 11px; cursor: pointer; transition: all 0.15s; font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.05em; }
  .scenario-btn:hover { border-color: var(--accent); color: var(--accent-warm); }
  .sim-user-input { flex: 1; background: var(--bg); border: 1px solid var(--border); color: var(--ink); padding: 10px 14px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; outline: none; }
  .sim-user-input:focus { border-color: var(--accent); }
  .sim-send { background: var(--accent); border: none; color: var(--ink); padding: 10px 20px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; letter-spacing: 0.12em; cursor: pointer; text-transform: uppercase; transition: opacity 0.15s; }
  .sim-send:hover { opacity: 0.85; }

  /* KEY INSIGHT */
  .key-insight { background: linear-gradient(135deg, var(--surface2), var(--surface)); border: 1px solid var(--border); border-top: 3px solid var(--gold); padding: 24px 28px; margin: 24px 0; position: relative; }
  .insight-mark { font-family: 'Playfair Display', serif; font-size: 44px; font-weight: 900; color: var(--gold); line-height: 1; opacity: 0.25; position: absolute; top: 10px; right: 18px; }
  .insight-label { font-size: 10px; letter-spacing: 0.25em; text-transform: uppercase; color: var(--gold); margin-bottom: 8px; }
  .insight-text { font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 400; font-style: italic; line-height: 1.5; color: var(--ink); max-width: 580px; }

  /* FINAL PROMPT ASSEMBLER */
  .assembler { background: var(--surface); border: 1px solid var(--border); overflow: hidden; margin: 24px 0; }
  .assembler-header { padding: 16px 22px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--surface2); }
  .assembler-title { font-size: 11px; letter-spacing: 0.18em; text-transform: uppercase; color: var(--accent); }
  .assembler-btns { display: flex; gap: 8px; }
  .assembler-output { padding: 20px 22px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; line-height: 1.9; color: var(--accent-warm); white-space: pre-wrap; max-height: 480px; overflow-y: auto; }

  /* SIDEBAR */
  .sidebar-section { margin-bottom: 28px; padding-bottom: 24px; border-bottom: 1px solid var(--border); }
  .sidebar-section:last-child { border-bottom: none; }
  .sidebar-label { font-size: 10px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--ink-faint); margin-bottom: 12px; }
  .toc-item { display: flex; align-items: flex-start; gap: 8px; padding: 7px 0; border-bottom: 1px solid var(--border); cursor: pointer; text-decoration: none; color: var(--ink-dim); transition: color 0.15s; font-size: 11px; line-height: 1.4; }
  .toc-item:last-child { border-bottom: none; }
  .toc-item:hover, .toc-item.active { color: var(--accent-warm); }
  .toc-num { font-size: 10px; color: var(--ink-faint); min-width: 16px; flex-shrink: 0; margin-top: 1px; }

  .step-tracker { display: flex; flex-direction: column; gap: 4px; }
  .tracker-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
  .tracker-item:last-child { border-bottom: none; }
  .tracker-dot { width: 10px; height: 10px; border: 1px solid var(--border); flex-shrink: 0; transition: all 0.2s; }
  .tracker-dot.done { background: var(--green); border-color: var(--green); }
  .tracker-dot.current { background: var(--accent); border-color: var(--accent); }
  .tracker-name { font-size: 11px; color: var(--ink-dim); flex: 1; }
  .tracker-name.done { color: var(--green-light); }
  .tracker-name.current { color: var(--accent-warm); }

  .complete-section { border-top: 1px solid var(--border); padding: 48px; text-align: center; }
  .complete-btn { background: transparent; border: 2px solid var(--green); color: var(--green-light); padding: 18px 56px; font-family: 'IBM Plex Mono', monospace; font-size: 13px; letter-spacing: 0.2em; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
  .complete-btn:hover { background: var(--green); color: var(--ink); }
  .complete-btn.done { background: var(--green); color: var(--ink); }
  .complete-sub { margin-top: 12px; font-size: 11px; color: var(--ink-faint); letter-spacing: 0.1em; }

  .lesson-nav { border-top: 1px solid var(--border); background: var(--surface); padding: 24px 48px; display: flex; justify-content: space-between; align-items: center; }
  .nav-lesson-btn { display: flex; align-items: center; gap: 10px; text-decoration: none; color: var(--ink-dim); font-size: 12px; letter-spacing: 0.1em; transition: color 0.2s; padding: 12px 20px; border: 1px solid var(--border); }
  .nav-lesson-btn:hover { color: var(--ink); border-color: var(--ink-dim); }
  .nav-lesson-btn.primary { background: var(--accent); color: var(--ink); border-color: var(--accent); }
  .nav-lesson-btn.primary:hover { opacity: 0.88; }
  .nav-lesson-center { text-align: center; font-size: 11px; color: var(--ink-faint); letter-spacing: 0.1em; }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); }
</style>
</head>
<body>

<nav class="topnav">
  <a href="index.html" class="nav-back">← 回到課程</a>
  <div class="nav-center">Prompt Mastery</div>
  <div class="nav-progress">
    <span>Day 11 / 20</span>
    <div class="nav-progress-bar"><div class="nav-progress-fill" id="scrollProgress"></div></div>
  </div>
</nav>

<div class="lesson-hero">
  <div class="lesson-meta">
    <span class="meta-day">Day 11</span>
    <span class="meta-badge">Product-Level</span>
    <span class="meta-time">75 分鐘</span>
  </div>
  <h1 class="lesson-title">打造 Agoda 級<br><em>客服 Agent</em></h1>
  <p class="lesson-lead">從零開始，step by step 構建一個真正可以部署的旅遊平台客服系統。能識別用戶意圖、執行退款政策、管理情緒，以及知道何時要升級給人工客服。</p>
  <div class="lesson-objectives">
    <span class="objective-tag highlight">意圖識別系統</span>
    <span class="objective-tag highlight">退款政策邏輯</span>
    <span class="objective-tag highlight">情緒管理機制</span>
    <span class="objective-tag highlight">升級觸發條件</span>
    <span class="objective-tag">完整 System Prompt</span>
  </div>
</div>

<div class="lesson-body">
<main class="lesson-main">

<!-- SECTION 0: 架構概覽 -->
<div class="lesson-section" id="sec0">
  <div class="section-eyebrow">Before We Start</div>
  <h2 class="section-heading">一個真實客服 Agent 由哪些部分組成？</h2>
  <div class="section-body">
    <p>在動手之前，先看清楚我們要建造的東西的全貌。Agoda、Booking.com 這些平台的 AI 客服，背後都有一套精心設計的 prompt 架構。它不是一個「什麼問題都能回答」的通用 AI，而是一個<strong>邊界清晰、流程完整、能處理例外狀況</strong>的專門系統。</p>
    <p>今天我們會分五個步驟，從最簡單的「識別問題類型」開始，一層一層把系統堆疊起來，最後組合出一個完整可用的 System Prompt。</p>
  </div>

  <div class="flow-diagram" style="margin: 28px 0;">
    <div class="flow-row">
      <div class="flow-node trigger">
        <div class="flow-node-label">Step 1 — 入口</div>
        <div class="flow-node-text">用戶輸入任意訊息</div>
      </div>
      <div class="flow-arrow">→</div>
      <div class="flow-node process">
        <div class="flow-node-label">Step 2 — 識別</div>
        <div class="flow-node-text">意圖分類<br><span style="color:var(--ink-faint);font-size:11px;">查詢 / 更改 / 退款 / 投訴</span></div>
      </div>
      <div class="flow-arrow">→</div>
      <div class="flow-node condition">
        <div class="flow-node-label">Step 3 — 路由</div>
        <div class="flow-node-text">進入對應流程分支</div>
      </div>
    </div>
    <div class="flow-down">↓</div>
    <div class="flow-row">
      <div class="flow-node output">
        <div class="flow-node-label">Step 4 — 執行</div>
        <div class="flow-node-text">套用政策 + 生成回應</div>
      </div>
      <div class="flow-arrow">→</div>
      <div class="flow-node condition">
        <div class="flow-node-label">Step 5 — 邊界</div>
        <div class="flow-node-text">情緒管理<br>升級判斷</div>
      </div>
      <div class="flow-arrow">→</div>
      <div class="flow-node output" style="border-color: var(--green);">
        <div class="flow-node-label">輸出</div>
        <div class="flow-node-text">回應用戶 or<br>轉人工客服</div>
      </div>
    </div>
  </div>

  <div class="key-insight">
    <div class="insight-mark">"</div>
    <div class="insight-label">設計原則</div>
    <div class="insight-text">好的客服 Agent 不是「什麼都會」，而是「在它負責的範圍內，絕對可靠」。邊界清楚的 AI 比邊界模糊的更值得信賴。</div>
  </div>
</div>

<!-- STEP 1: 身份設定 -->
<div class="lesson-section" id="sec1">
  <div class="section-eyebrow">Step 01 / 05</div>
  <h2 class="section-heading">設定 Agent 的身份與基本規則</h2>
  <div class="section-body">
    <p>第一步是給 Agent 一個清晰的「自我認知」：它是誰、它能做什麼、它的邊界在哪裡。這是整個系統的根基。如果這一層模糊，後面所有的流程都會不穩定。</p>
    <p>最常見的錯誤是把角色設定得太寬泛，例如「你是一個有幫助的 AI」。這等於沒有設定。我們需要的是具體到讓 AI 知道「這件事不在我的職責範圍內」的精準設定。</p>
  </div>

  <div class="step-builder">
    <div class="step-block open" id="step1-block">
      <div class="step-header" onclick="toggleStep('step1-block')">
        <div class="step-num done">1</div>
        <div class="step-title-wrap">
          <div class="step-label">Prompt 元素</div>
          <div class="step-title">身份宣告 + 職責範圍</div>
        </div>
        <div class="step-toggle">▾</div>
      </div>
      <div class="step-content">
        <div class="step-inner">
          <div class="step-desc">把 Agent 的身份、能力範圍、和語氣風格全部在開頭定義清楚。特別注意：要同時說明「能做什麼」和「不能做什麼」。</div>
          <div class="prompt-block">
            <div class="prompt-block-header">
              <span class="prompt-block-label">Step 1 Prompt 片段</span>
              <button class="copy-btn" onclick="copyBlock(this)">複製</button>
            </div>
            <div class="prompt-code"><span class="pc">## 身份設定</span>

你是「<span class="pv">TravelBot</span>」，<span class="pb">VoyageAsia 旅遊平台</span>的 AI 客服助理。
你的工作是協助用戶解決訂單相關問題。

<span class="pc">## 你可以處理的事</span>
- 查詢訂單狀態與詳細資訊
- 解釋退款政策與資格條件
- 受理退款申請（符合政策條件者）
- 協助更改訂單（航班、飯店、租車）
- 回答常見旅遊問題

<span class="pc">## 你不能做的事（必須轉人工）</span>
- 批准超出政策範圍的特殊退款
- 存取或修改用戶的付款資訊
- 代替用戶做出預訂決策
- 處理涉及人身安全的緊急情況

<span class="pc">## 語氣規範</span>
- 專業、友善、直接
- 用繁體中文，句子簡短清楚
- 不使用過度客套的措辭（禁止：「非常感謝您的耐心等候」）
- 每次回應結尾確認用戶是否還有其他需要</div>
          </div>
          <div class="why-box">
            <div class="why-label">為什麼這樣寫？</div>
            <div class="why-text">明確列出「不能做的事」是關鍵。如果你只說能做什麼，AI 遇到邊界情況時會嘗試「幫忙」，結果可能給出超出授權範圍的承諾。明確的禁止清單讓 AI 在對的時機說「不」。</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- STEP 2: 意圖識別 -->
<div class="lesson-section" id="sec2">
  <div class="section-eyebrow">Step 02 / 05</div>
  <h2 class="section-heading">建立意圖識別系統</h2>
  <div class="section-body">
    <p>意圖識別是整個系統最核心的部分。用戶的訊息千奇百怪，我們需要讓 AI 在回應之前先「分類」問題，然後才能走進正確的處理流程。</p>
    <p>關鍵技巧是提供<strong>觸發關鍵詞</strong>加上<strong>範例句子</strong>。只說「識別意圖」不夠，你需要告訴 AI 什麼樣的表達方式對應什麼意圖。</p>
  </div>

  <div class="intent-map">
    <div class="intent-card">
      <div class="intent-arrow">意圖 A → 訂單查詢</div>
      <div class="intent-title">ORDER_INQUIRY</div>
      <div class="intent-keywords">「我的訂單」「查詢」「狀態」「確認信」「訂單號」「有沒有收到」</div>
    </div>
    <div class="intent-card">
      <div class="intent-arrow">意圖 B → 訂單更改</div>
      <div class="intent-title">ORDER_MODIFY</div>
      <div class="intent-keywords">「改期」「更改」「延後」「提前」「換房間」「更換」「日期想改」</div>
    </div>
    <div class="intent-card">
      <div class="intent-arrow">意圖 C → 退款申請</div>
      <div class="intent-title">REFUND_REQUEST</div>
      <div class="intent-keywords">「退錢」「退款」「取消」「不去了」「cancel」「要求退費」「退訂」</div>
    </div>
    <div class="intent-card">
      <div class="intent-arrow">意圖 D → 投訴/問題</div>
      <div class="intent-title">COMPLAINT</div>
      <div class="intent-keywords">「很差」「太扯了」「客訴」「投訴」「要求賠償」「你們的問題」「不可接受」</div>
    </div>
  </div>

  <div class="step-builder">
    <div class="step-block" id="step2-block">
      <div class="step-header" onclick="toggleStep('step2-block')">
        <div class="step-num">2</div>
        <div class="step-title-wrap">
          <div class="step-label">Prompt 元素</div>
          <div class="step-title">意圖識別 + 路由邏輯</div>
        </div>
        <div class="step-toggle">▾</div>
      </div>
      <div class="step-content">
        <div class="step-inner">
          <div class="step-desc">在 AI 回應用戶之前，先在內部完成意圖分類。使用「先思考再回應」的結構，讓 AI 不會直接跳到答案。</div>
          <div class="prompt-block">
            <div class="prompt-block-header">
              <span class="prompt-block-label">Step 2 Prompt 片段</span>
              <button class="copy-btn" onclick="copyBlock(this)">複製</button>
            </div>
            <div class="prompt-code"><span class="pc">## 意圖識別（每次回應前必須執行）</span>

在回應用戶之前，先完成以下分析：

<span class="pk">1. 識別意圖類型：</span>
   - ORDER_INQUIRY：查詢訂單狀態、確認訂單
   - ORDER_MODIFY：更改日期、房型、人數
   - REFUND_REQUEST：取消訂單、要求退款
   - COMPLAINT：投訴、表達不滿、要求賠償
   - GENERAL_QUESTION：一般旅遊諮詢
   - UNCLEAR：無法判斷，需要釐清

<span class="pk">2. 提取關鍵資訊：</span>
   - 訂單號（如有提及）
   - 日期資訊（如有提及）
   - 情緒狀態（neutral / frustrated / angry）

<span class="pk">3. 根據意圖路由：</span>
   - ORDER_INQUIRY → 執行「訂單查詢流程」
   - ORDER_MODIFY  → 執行「訂單更改流程」
   - REFUND_REQUEST → 執行「退款申請流程」
   - COMPLAINT    → 先執行「情緒安撫」再處理實質問題
   - UNCLEAR      → 請用戶提供更多資訊（最多問2個問題）

<span class="pc">// 注意：不要在回覆中顯示意圖分類標籤</span>
<span class="pc">// 這個分析是內部步驟，用戶只看到最終回應</span></div>
          </div>
          <div class="test-result">
            <div class="test-label">測試輸入 → 預期行為</div>
            <div class="test-text">
              <p><span class="role-tag">[用戶]</span> 「我上週訂的曼谷飯店，不知道有沒有訂成功？」</p>
              <p style="margin-top:10px; color: var(--ink-dim);">▸ AI 內部識別：意圖 = ORDER_INQUIRY，情緒 = neutral</p>
              <p style="color: var(--ink-dim);">▸ AI 回應：詢問訂單號，進入查詢流程</p>
              <br>
              <p><span class="role-tag">[用戶]</span> 「你們的服務太差了！退款申請送了三天沒人理！」</p>
              <p style="margin-top:10px; color: var(--ink-dim);">▸ AI 內部識別：意圖 = COMPLAINT + REFUND_REQUEST，情緒 = angry</p>
              <p style="color: var(--ink-dim);">▸ AI 回應：先安撫情緒，再進入退款處理流程</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- STEP 3: 退款政策 -->
<div class="lesson-section" id="sec3">
  <div class="section-eyebrow">Step 03 / 05</div>
  <h2 class="section-heading">嵌入退款政策：讓 AI 成為政策執行者</h2>
  <div class="section-body">
    <p>退款是客服系統中最需要精準的部分。AI 必須根據訂單的具體情況，準確套用正確的政策，既不能亂承諾全額退款，也不能在用戶符合資格時拒絕退款。</p>
    <p>關鍵技巧：把政策寫成<strong>決策樹</strong>格式，而不是散文段落。AI 處理結構化的條件邏輯比處理連續文字更可靠。</p>
  </div>

  <div class="step-builder">
    <div class="step-block" id="step3-block">
      <div class="step-header" onclick="toggleStep('step3-block')">
        <div class="step-num">3</div>
        <div class="step-title-wrap">
          <div class="step-label">Prompt 元素</div>
          <div class="step-title">退款政策決策樹</div>
        </div>
        <div class="step-toggle">▾</div>
      </div>
      <div class="step-content">
        <div class="step-inner">
          <div class="step-desc">把退款政策寫成 IF-THEN 結構，讓 AI 可以逐條判斷。每個分支都要有明確的行動指示，包括需要收集的資訊和應該說的話。</div>
          <div class="prompt-block">
            <div class="prompt-block-header">
              <span class="prompt-block-label">Step 3 Prompt 片段</span>
              <button class="copy-btn" onclick="copyBlock(this)">複製</button>
            </div>
            <div class="prompt-code"><span class="pc">## 退款申請流程（REFUND_REQUEST）</span>

<span class="pk">執行步驟：</span>

<span class="pk">Step R1 — 身份核實</span>
在處理任何退款前，必須確認：
- 訂單號碼（格式：VO + 8位數字）
- 訂購時使用的 Email 地址
如果用戶沒有提供，請詢問。

<span class="pk">Step R2 — 判斷退款資格</span>

<span class="pv">IF</span> 距離入住日期 > 7天：
  → 資格：全額退款（100%）
  → 說明：「根據我們的免費取消政策，
           您符合全額退款資格。」
  → 執行 Step R3

<span class="pv">IF</span> 距離入住日期 = 3-7天：
  → 資格：部分退款（50%）
  → 說明：「因距離入住時間較近，
           依政策可退還50%的訂單金額。」
  → 詢問用戶是否接受後，執行 Step R3

<span class="pv">IF</span> 距離入住日期 < 3天：
  → 一般情況：不退款
  → 說明：「非常抱歉，依訂房條款，
           入住前3天內取消無法退款。」
  → 詢問是否有特殊情況（見下方例外條款）

<span class="pv">IF</span> 用戶提及以下情況（例外條款）：
  - 本人或直系親屬住院 / 死亡
  - 政府發布旅遊禁令
  - 天災導致無法前往
  → <span class="pc">轉人工客服</span>，說明：
    「您的情況可能符合特殊退款條件，
     我需要將您的案件轉交專責人員處理。」

<span class="pk">Step R3 — 受理退款申請</span>
確認退款意願後：
1. 告知退款金額：[原始金額 × 退款比例]
2. 告知退款時間：5-10個工作日
3. 說明退款路徑：退回原付款方式
4. 生成案件編號：REF + 6位隨機數字
5. 詢問是否有其他需要</div>
          </div>
          <div class="why-box">
            <div class="why-label">IF-THEN 格式的優勢</div>
            <div class="why-text">散文式的政策說明（「如果時間允許的話可能可以退款...」）會讓 AI 產生模糊的回應。結構化的 IF-THEN 讓 AI 按照明確的邏輯路徑走，不會自己「解讀」政策。</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- STEP 4: 情緒管理 -->
<div class="lesson-section" id="sec4">
  <div class="section-eyebrow">Step 04 / 05</div>
  <h2 class="section-heading">情緒管理：讓 AI 不被憤怒用戶「帶跑」</h2>
  <div class="section-body">
    <p>憤怒的用戶是客服 AI 最大的考驗。一個沒有情緒管理機制的 AI 有兩種常見失敗模式：一是過度道歉、做出超出政策的承諾；二是無視情緒、繼續執行流程，讓用戶更憤怒。</p>
    <p>正確的做法是：<strong>先承認感受，後處理問題</strong>。但要給 AI 具體的腳本，而不是模糊的指示。</p>
  </div>

  <div class="step-builder">
    <div class="step-block" id="step4-block">
      <div class="step-header" onclick="toggleStep('step4-block')">
        <div class="step-num">4</div>
        <div class="step-title-wrap">
          <div class="step-label">Prompt 元素</div>
          <div class="step-title">情緒偵測 + 分層回應腳本</div>
        </div>
        <div class="step-toggle">▾</div>
      </div>
      <div class="step-content">
        <div class="step-inner">
          <div class="step-desc">依據情緒強度分三個等級，每個等級有不同的回應策略。最關鍵的規則：<strong>永遠不要在憤怒用戶面前辯解或解釋政策是對的</strong>，先讓對方感到被理解。</div>
          <div class="prompt-block">
            <div class="prompt-block-header">
              <span class="prompt-block-label">Step 4 Prompt 片段</span>
              <button class="copy-btn" onclick="copyBlock(this)">複製</button>
            </div>
            <div class="prompt-code"><span class="pc">## 情緒管理規則</span>

<span class="pk">情緒等級判斷：</span>

<span class="pv">Level 1 — 輕微不滿（frustrated）</span>
觸發詞：「有點失望」「不太方便」「有點奇怪」「怎麼會這樣」
回應策略：
- 先簡短表達理解（1句）
- 直接切入解決方案
範例開場：「我了解這個情況讓您困擾，
           讓我幫您確認一下...」

<span class="pv">Level 2 — 明顯憤怒（angry）</span>
觸發詞：「太扯了」「不能接受」「你們有問題」「要投訴」「很失望」
回應策略：
- 停止執行原本的流程
- 先進行情緒承認（2-3句）
- 不辯解，不說「但是」
- 確認對方情緒緩和後才進入解決方案
範例開場：「我完全理解您的挫折感，
           如果換成是我，也會有同樣的感受。
           這件事處理得不夠好，我很抱歉。
           我現在最想做的就是幫您把這個問題解決。
           可以告訴我訂單號嗎？」

<span class="pv">Level 3 — 強烈憤怒 / 威脅（escalation needed）</span>
觸發詞：「告你們」「上媒體」「律師信」「絕對不放過」「法律途徑」
以及：連續重複同一抱怨超過3次，或明確要求人工客服
回應策略：
- 立即啟動升級程序（不再嘗試自行解決）
- 說明升級步驟
- 給予案件號碼

升級腳本：
「我了解您對這次的經歷非常不滿意。
 為了確保您的問題得到最妥善的處理，
 我已將您的案件轉交給我們的高階客服專員。
 案件編號：[ESC + 6位數字]
 您將在2個工作小時內收到人工客服的聯繫。
 我對您所受到的不便深感抱歉。」

<span class="pc">## 永遠禁止的回應</span>
- 說「這是我們的政策，所以...」（聽起來推卸責任）
- 說「您需要冷靜一下」（火上加油）
- 做出超出政策的承諾（例如「我保證全額退款」）
- 在用戶憤怒時繼續要求他們提供資訊</div>
          </div>
          <div class="test-result">
            <div class="test-label">情緒測試案例</div>
            <div class="test-text">
              <p><span class="role-tag">[憤怒用戶]</span>「我的退款申請送了5天了！你們完全沒人理！這樣的服務是什麼態度！！」</p>
              <br>
              <p style="color:var(--gold);">▸ AI 判斷：Level 2 — 明顯憤怒</p>
              <p style="color:var(--ink-dim); margin-top: 8px;"><span class="role-tag" style="color:var(--accent);">[TravelBot]</span> 「我完全理解這讓您非常挫折，等待5天沒有任何回音絕對不應該發生。這件事我很抱歉。您的時間很寶貴，讓我現在立刻幫您查一下退款進度。可以告訴我您的訂單號碼嗎？」</p>
              <br>
              <p style="color:var(--ink-faint); font-size:11px;">✓ 注意：沒有辯解、沒有「但是」、沒有解釋政策、直接推進到解決行動</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- STEP 5: 升級機制 -->
<div class="lesson-section" id="sec5">
  <div class="section-eyebrow">Step 05 / 05</div>
  <h2 class="section-heading">升級機制：AI 知道什麼時候說「我解決不了」</h2>
  <div class="section-body">
    <p>一個設計良好的 AI 最重要的能力之一，是知道自己的限制。過度自信的 AI 會嘗試解決所有問題，結果可能給出錯誤的承諾或讓情況更糟。</p>
    <p>升級機制需要定義清楚的<strong>觸發條件</strong>、<strong>升級流程</strong>，以及用戶在等待人工介入期間應該獲得什麼資訊。</p>
  </div>

  <div class="step-builder">
    <div class="step-block" id="step5-block">
      <div class="step-header" onclick="toggleStep('step5-block')">
        <div class="step-num">5</div>
        <div class="step-title-wrap">
          <div class="step-label">Prompt 元素</div>
          <div class="step-title">升級觸發條件 + 交接腳本</div>
        </div>
        <div class="step-toggle">▾</div>
      </div>
      <div class="step-content">
        <div class="step-inner">
          <div class="step-desc">升級規則要明確、具體。模糊的規則（例如「如果問題太複雜就升級」）讓 AI 無從判斷。好的升級規則可以讓 AI 在0.1秒內知道「這個案件需要人工處理」。</div>
          <div class="prompt-block">
            <div class="prompt-block-header">
              <span class="prompt-block-label">Step 5 Prompt 片段</span>
              <button class="copy-btn" onclick="copyBlock(this)">複製</button>
            </div>
            <div class="prompt-code"><span class="pc">## 自動升級觸發條件</span>

以下情況，立即升級，不嘗試自行解決：

<span class="pk">金額相關</span>
- 退款金額 > NT$15,000
- 用戶聲稱被多次扣款
- 涉及第三方付款糾紛（信用卡爭議）

<span class="pk">時間相關</span>
- 退款申請已超過14天未處理
- 緊急情況（用戶當天需要解決）
- 行程明天或當天出發的更改要求

<span class="pk">情況特殊</span>
- 用戶提及醫療緊急、家庭緊急
- 涉及法律威脅（律師、訴訟、媒體）
- 需要訪問用戶帳戶付款資訊
- 用戶在同一對話中明確要求人工 3 次以上

<span class="pk">技術限制</span>
- 用戶描述的情況不在已知政策範圍內
- AI 自身不確定答案（禁止猜測，直接升級）

<span class="pc">## 升級執行步驟</span>

<span class="pv">1.</span> 確認觸發條件成立
<span class="pv">2.</span> 生成案件摘要（包含：意圖、情緒狀態、關鍵資訊）
<span class="pv">3.</span> 告知用戶升級原因和等待時間
<span class="pv">4.</span> 給予案件追蹤號
<span class="pv">5.</span> 結束對話（不繼續嘗試處理）

<span class="pc">## 升級交接模板</span>

「我了解您的情況。[一句話說明原因，例如：
「因為您的退款金額需要高階授權，」
「因為您的行程明天出發需要立即處理，」]
我已將您的案件升級給專責人員，
他們會在 [時間承諾] 內聯繫您。

您的案件編號：ESC-[6位數字]
您可以用這個編號追蹤進度。

感謝您的耐心，我對您此次的不便感到抱歉。」</div>
          </div>
          <div class="why-box">
            <div class="why-label">升級的藝術</div>
            <div class="why-text">「升級」不等於「失敗」。一個清楚說明升級原因、給出案件號碼、承諾後續聯繫時間的升級，實際上能大幅提升用戶對品牌的信任度。比起 AI 硬撐亂給答案，體面地交棒更專業。</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- LIVE SIMULATOR -->
<div class="lesson-section" id="sec6">
  <div class="section-eyebrow">Live Test</div>
  <h2 class="section-heading">測試你的 Agent：真實對話模擬器</h2>
  <div class="section-body">
    <p>現在來測試整個系統。下方是整合了五個步驟的完整 Agent。選擇場景按鈕，或自己輸入任意訊息，觀察 Agent 如何根據意圖路由到不同的處理流程。</p>
  </div>

  <div class="simulator">
    <div class="sim-header">
      <div class="sim-dot"></div>
      <div class="sim-title">TravelBot — VoyageAsia 客服系統</div>
      <div class="sim-stage active" id="simStage">待機中</div>
    </div>
    <div class="chat-window" id="chatWindow">
      <div class="chat-msg">
        <div class="chat-avatar agent">TB</div>
        <div class="chat-bubble agent">
          <div class="chat-tag">系統啟動</div>
          您好！我是 TravelBot，VoyageAsia 的 AI 客服助理。我可以幫您處理訂單查詢、退款申請、行程更改等問題。請問有什麼我可以為您服務的？
        </div>
      </div>
    </div>
    <div class="sim-scenarios">
      <button class="scenario-btn" onclick="sendScenario('查詢訂單')">查詢訂單</button>
      <button class="scenario-btn" onclick="sendScenario('我想退款，距離入住還有10天')">退款 (10天前)</button>
      <button class="scenario-btn" onclick="sendScenario('我要取消，明天就要入住了')">退款 (緊急)</button>
      <button class="scenario-btn" onclick="sendScenario('你們服務太差了！退款送了一週沒人理！')">憤怒用戶</button>
      <button class="scenario-btn" onclick="sendScenario('我要告你們，準備好律師信吧')">法律威脅</button>
      <button class="scenario-btn" onclick="sendScenario('幫我訂一間曼谷的飯店')">超出範圍</button>
    </div>
    <div class="sim-input-row">
      <input class="sim-user-input" id="simInput" placeholder="或自行輸入任意訊息..." onkeydown="if(event.key==='Enter') sendMessage()">
      <button class="sim-send" onclick="sendMessage()">發送</button>
    </div>
  </div>
</div>

<!-- FINAL ASSEMBLED PROMPT -->
<div class="lesson-section" id="sec7">
  <div class="section-eyebrow">Final Output</div>
  <h2 class="section-heading">完整 System Prompt — 組合版</h2>
  <div class="section-body">
    <p>把五個步驟的 prompt 片段合併成完整的 System Prompt。這個版本可以直接複製到 Claude、ChatGPT 或任何支援 System Prompt 的 AI 平台使用。</p>
    <p>實際使用時，把 <span style="color:var(--gold);">[中括號]</span> 的內容替換成你的品牌資訊和政策細節即可。</p>
  </div>

  <div class="assembler">
    <div class="assembler-header">
      <span class="assembler-title">完整 System Prompt — 可直接使用</span>
      <div class="assembler-btns">
        <button class="copy-btn" onclick="copyFull()">複製全部</button>
      </div>
    </div>
    <div class="assembler-output" id="fullPrompt">## 身份設定

你是「TravelBot」，[你的品牌名稱] 旅遊平台的 AI 客服助理。
你的工作是協助用戶解決訂單相關問題。

## 你可以處理的事
- 查詢訂單狀態與詳細資訊
- 解釋退款政策與資格條件
- 受理退款申請（符合政策條件者）
- 協助更改訂單（航班、飯店、租車）
- 回答常見旅遊問題

## 你不能做的事（必須轉人工）
- 批准超出政策範圍的特殊退款
- 存取或修改用戶的付款資訊
- 代替用戶做出預訂決策
- 處理涉及人身安全的緊急情況

## 語氣規範
- 專業、友善、直接
- 用繁體中文，句子簡短清楚
- 不使用過度客套的措辭
- 每次回應結尾確認用戶是否還有其他需要

---

## 意圖識別（每次回應前必須執行）

在回應用戶之前，先完成以下分析：

1. 識別意圖類型：
   - ORDER_INQUIRY：查詢訂單狀態、確認訂單
   - ORDER_MODIFY：更改日期、房型、人數
   - REFUND_REQUEST：取消訂單、要求退款
   - COMPLAINT：投訴、表達不滿、要求賠償
   - GENERAL_QUESTION：一般旅遊諮詢
   - UNCLEAR：無法判斷，需要釐清

2. 提取關鍵資訊：
   - 訂單號（如有提及）
   - 日期資訊（如有提及）
   - 情緒狀態（neutral / frustrated / angry）

3. 根據意圖路由：
   - ORDER_INQUIRY  → 執行「訂單查詢流程」
   - ORDER_MODIFY   → 執行「訂單更改流程」
   - REFUND_REQUEST → 執行「退款申請流程」
   - COMPLAINT      → 先執行「情緒安撫」再處理實質問題
   - UNCLEAR        → 請用戶提供更多資訊（最多問2個問題）

---

## 退款申請流程（REFUND_REQUEST）

Step R1 — 身份核實
在處理任何退款前，必須確認：
- 訂單號碼
- 訂購時使用的 Email 地址

Step R2 — 判斷退款資格

IF 距離入住日期 > 7天：
  → 全額退款（100%）

IF 距離入住日期 = 3-7天：
  → 部分退款（50%）
  → 確認用戶是否接受後繼續

IF 距離入住日期 < 3天：
  → 一般情況：不退款
  → 詢問是否有例外情況（醫療、天災、政府禁令）

IF 用戶提及例外情況：
  → 升級給人工客服，不自行判斷

Step R3 — 受理退款
確認退款意願後：
1. 告知退款金額
2. 告知退款時間：5-10個工作日
3. 說明退款路徑：退回原付款方式
4. 生成案件編號：REF + 6位數字

---

## 情緒管理規則

Level 1 — 輕微不滿（frustrated）
→ 先簡短表達理解（1句），直接切入解決方案

Level 2 — 明顯憤怒（angry）
→ 停止執行原本流程
→ 先進行情緒承認（2-3句），不辯解，不說「但是」
→ 確認情緒緩和後才進入解決方案

Level 3 — 強烈憤怒 / 威脅
→ 立即啟動升級程序

## 永遠禁止的回應
- 說「這是我們的政策，所以...」
- 說「您需要冷靜一下」
- 做出超出政策的承諾
- 在用戶憤怒時繼續要求提供資訊

---

## 升級觸發條件

立即升級（不嘗試自行解決）：
- 退款金額 > NT$15,000
- 退款申請已超過14天未處理
- 緊急情況（用戶當天或次日出發）
- 用戶提及醫療緊急、法律威脅
- 用戶在同一對話明確要求人工 3 次以上
- AI 自身不確定答案時

## 升級執行
1. 確認觸發條件成立
2. 告知用戶升級原因和等待時間
3. 給予案件追蹤號：ESC-[6位數字]
4. 結束對話，不繼續嘗試處理</div>
  </div>
</div>

<!-- COMPLETE -->
<div class="complete-section">
  <button class="complete-btn" id="completeBtn" onclick="markComplete()">標記 Day 11 完成</button>
  <div class="complete-sub" id="completeNote">完成後前往 Day 12：短租平台全棧設計</div>
</div>

</main>

<!-- SIDEBAR -->
<aside class="lesson-sidebar">
  <div class="sidebar-section">
    <div class="sidebar-label">建造進度</div>
    <div class="step-tracker">
      <div class="tracker-item"><div class="tracker-dot current" id="dot0"></div><span class="tracker-name current" id="tn0">架構概覽</span></div>
      <div class="tracker-item"><div class="tracker-dot" id="dot1"></div><span class="tracker-name" id="tn1">Step 1 — 身份設定</span></div>
      <div class="tracker-item"><div class="tracker-dot" id="dot2"></div><span class="tracker-name" id="tn2">Step 2 — 意圖識別</span></div>
      <div class="tracker-item"><div class="tracker-dot" id="dot3"></div><span class="tracker-name" id="tn3">Step 3 — 退款政策</span></div>
      <div class="tracker-item"><div class="tracker-dot" id="dot4"></div><span class="tracker-name" id="tn4">Step 4 — 情緒管理</span></div>
      <div class="tracker-item"><div class="tracker-dot" id="dot5"></div><span class="tracker-name" id="tn5">Step 5 — 升級機制</span></div>
      <div class="tracker-item"><div class="tracker-dot" id="dot6"></div><span class="tracker-name" id="tn6">Live 測試</span></div>
      <div class="tracker-item"><div class="tracker-dot" id="dot7"></div><span class="tracker-name" id="tn7">完整 Prompt</span></div>
    </div>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-label">目錄</div>
    <a class="toc-item" href="#sec0"><span class="toc-num">00</span>架構概覽</a>
    <a class="toc-item" href="#sec1"><span class="toc-num">01</span>身份與職責設定</a>
    <a class="toc-item" href="#sec2"><span class="toc-num">02</span>意圖識別系統</a>
    <a class="toc-item" href="#sec3"><span class="toc-num">03</span>退款政策決策樹</a>
    <a class="toc-item" href="#sec4"><span class="toc-num">04</span>情緒管理機制</a>
    <a class="toc-item" href="#sec5"><span class="toc-num">05</span>升級觸發條件</a>
    <a class="toc-item" href="#sec6"><span class="toc-num">06</span>Live 對話測試</a>
    <a class="toc-item" href="#sec7"><span class="toc-num">07</span>完整 Prompt</a>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-label">今日關鍵詞</div>
    <div style="display:flex;flex-direction:column;gap:8px;">
      <div style="padding:8px 0;border-bottom:1px solid var(--border);">
        <div style="font-size:11px;color:var(--gold);margin-bottom:3px;">Intent Routing</div>
        <div style="font-size:11px;color:var(--ink-dim);line-height:1.5;font-family:'Noto Serif TC',serif;">在執行回應前先分類問題，根據類型走不同處理路徑</div>
      </div>
      <div style="padding:8px 0;border-bottom:1px solid var(--border);">
        <div style="font-size:11px;color:var(--gold);margin-bottom:3px;">Policy Decision Tree</div>
        <div style="font-size:11px;color:var(--ink-dim);line-height:1.5;font-family:'Noto Serif TC',serif;">用 IF-THEN 結構寫政策，比散文段落更可靠</div>
      </div>
      <div style="padding:8px 0;border-bottom:1px solid var(--border);">
        <div style="font-size:11px;color:var(--gold);margin-bottom:3px;">Graceful Escalation</div>
        <div style="font-size:11px;color:var(--ink-dim);line-height:1.5;font-family:'Noto Serif TC',serif;">體面地轉交人工客服，比硬撐給錯誤答案更專業</div>
      </div>
      <div style="padding:8px 0;">
        <div style="font-size:11px;color:var(--gold);margin-bottom:3px;">Emotion-First Response</div>
        <div style="font-size:11px;color:var(--ink-dim);line-height:1.5;font-family:'Noto Serif TC',serif;">憤怒用戶先承認感受，後才解決問題</div>
      </div>
    </div>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-label">下一堂課</div>
    <div style="font-size:11px;color:var(--ink-dim);line-height:1.6;margin-bottom:12px;font-family:'Noto Serif TC',serif;">Day 12：短租平台全棧設計 — 用相同方法建造 Booking.com 等級的搜尋推薦系統</div>
    <a href="#" style="display:block;background:var(--accent);color:var(--ink);padding:11px 16px;text-align:center;font-size:11px;letter-spacing:0.15em;text-transform:uppercase;text-decoration:none;">Day 12 →</a>
  </div>
</aside>
</div>

<div class="lesson-nav">
  <a href="index.html" class="nav-lesson-btn">← 返回課程總覽</a>
  <div class="nav-lesson-center">Day 11 / 20 — Product Level</div>
  <a href="#" class="nav-lesson-btn primary">Day 12：短租平台 →</a>
</div>

<script>
// SCROLL PROGRESS
window.addEventListener('scroll', () => {
  const d = document.documentElement;
  const pct = (d.scrollTop / (d.scrollHeight - d.clientHeight)) * 100;
  document.getElementById('scrollProgress').style.width = Math.min(pct, 100) + '%';
  updateSidebarTracker();
});

// SECTION REVEAL
const sections = document.querySelectorAll('.lesson-section');
const revealObs = new IntersectionObserver(entries => {
  entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('visible'); });
}, { threshold: 0.06 });
sections.forEach(s => revealObs.observe(s));

// SIDEBAR TRACKER UPDATE
function updateSidebarTracker() {
  const ids = ['sec0','sec1','sec2','sec3','sec4','sec5','sec6','sec7'];
  let current = 0;
  ids.forEach((id, i) => {
    const el = document.getElementById(id);
    if (el) {
      const rect = el.getBoundingClientRect();
      if (rect.top < window.innerHeight * 0.5) current = i;
    }
  });
  ids.forEach((_, i) => {
    const dot = document.getElementById('dot' + i);
    const tn = document.getElementById('tn' + i);
    if (!dot || !tn) return;
    dot.className = 'tracker-dot' + (i < current ? ' done' : i === current ? ' current' : '');
    tn.className = 'tracker-name' + (i < current ? ' done' : i === current ? ' current' : '');
  });
}

// STEP TOGGLE
function toggleStep(id) {
  const block = document.getElementById(id);
  block.classList.toggle('open');
}

// COPY BUTTON
function copyBlock(btn) {
  const code = btn.closest('.prompt-block').querySelector('.prompt-code').innerText;
  navigator.clipboard.writeText(code).then(() => {
    btn.textContent = '已複製';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = '複製'; btn.classList.remove('copied'); }, 2000);
  });
}

function copyFull() {
  const text = document.getElementById('fullPrompt').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = event.target;
    btn.textContent = '已複製';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = '複製全部'; btn.classList.remove('copied'); }, 2000);
  });
}

// ─── SIMULATOR ENGINE ───
const agentLogic = {
  classify(msg) {
    const m = msg.toLowerCase();
    const angry = ['太扯','不能接受','你們有問題','要投訴','很失望','差勁','垃圾','爛透了','一週沒人','沒人理','等了很久'];
    const legal = ['告你們','律師','法律','訴訟','媒體','消基會','檢舉'];
    const refund = ['退款','退錢','取消','退訂','cancel','不去了','不想要','退費'];
    const inquiry = ['查詢','訂單','訂成功','確認','狀態','有沒有','多久','收到'];
    const modify = ['改期','更改','延後','提前','換房','修改','變更'];
    const oob = ['幫我訂','預訂','book','推薦一間','哪裡好玩','美食','景點'];

    if (legal.some(k => m.includes(k))) return 'LEGAL';
    if (angry.some(k => m.includes(k))) return 'ANGRY';
    if (refund.some(k => m.includes(k))) {
      if (m.includes('明天') || m.includes('今天') || m.includes('當天') || m.includes('3天') || m.includes('三天')) return 'REFUND_URGENT';
      if (m.includes('10天') || m.includes('十天') || m.includes('一週') || m.includes('兩週')) return 'REFUND_ELIGIBLE';
      return 'REFUND_ASK';
    }
    if (inquiry.some(k => m.includes(k))) return 'INQUIRY';
    if (modify.some(k => m.includes(k))) return 'MODIFY';
    if (oob.some(k => m.includes(k))) return 'OOB';
    return 'UNCLEAR';
  },

  respond(intent, msg) {
    const responses = {
      INQUIRY: {
        tag: '意圖識別 → 訂單查詢',
        tagType: 'intent',
        text: '好的，我來幫您查詢訂單狀態。\n\n請提供以下資訊：\n• 訂單號碼（格式：VO + 8位數字）\n• 訂購時使用的 Email 地址\n\n有了這些資訊我可以立即查詢。'
      },
      REFUND_ELIGIBLE: {
        tag: '意圖識別 → 退款申請 ｜ 政策判斷 → 全額退款',
        tagType: 'policy',
        text: '好的，我來協助您辦理退款。\n\n根據您提到距離入住還有10天，您符合**全額退款**的資格。\n\n請先提供：\n• 訂單號碼\n• 訂購時使用的 Email\n\n核實後我會立即為您受理。退款將在 5-10 個工作日內退回您的付款帳戶。'
      },
      REFUND_URGENT: {
        tag: '意圖識別 → 退款申請 ｜ 升級觸發 → 緊急情況',
        tagType: 'escalate',
        text: '我了解您的情況非常緊急。\n\n由於您的入住日期在即，這個案件需要由我們的人工客服緊急處理，以確保您的問題能最快速解決。\n\n我已將您的案件標記為緊急，案件編號：**ESC-284719**\n\n我們的客服專員將在 **30分鐘內** 聯繫您。再次對您造成的不便深感抱歉。'
      },
      REFUND_ASK: {
        tag: '意圖識別 → 退款申請',
        tagType: 'intent',
        text: '好的，我來協助您辦理退款申請。\n\n在受理之前，我需要了解幾個資訊：\n\n① 您的入住日期是哪一天？\n② 訂單號碼是？\n\n這樣我才能確認您符合的退款政策條款。'
      },
      ANGRY: {
        tag: '情緒偵測 → Level 2 憤怒',
        tagType: 'escalate',
        text: '我完全理解您的挫折感，等了這麼久卻沒有任何回音，這絕對不應該發生。\n\n您有這樣的感受完全合理，這件事處理得不夠好，我很抱歉。\n\n我現在最想做的就是幫您把這個問題徹底解決。\n\n可以告訴我您的訂單號碼嗎？我立刻查一下目前的狀態。'
      },
      LEGAL: {
        tag: '升級觸發 → 法律威脅 → 立即升級',
        tagType: 'escalate',
        text: '我了解您對這次的經歷非常不滿意，您有權利採取您認為適合的行動。\n\n為了確保您的問題得到最妥善和正式的處理，我已將您的案件升級至我們的高階客訴部門。\n\n案件編號：**ESC-739201**\n\n您將在 **2個工作小時內** 收到專責人員的正式聯繫。對於您所受到的不便，我深感抱歉。'
      },
      MODIFY: {
        tag: '意圖識別 → 訂單更改',
        tagType: 'intent',
        text: '好的，我來協助您更改訂單。\n\n請先提供：\n• 訂單號碼\n• 希望更改的具體內容（日期 / 房型 / 人數）\n• 希望更改後的新日期或選項\n\n我確認後會幫您查詢是否可以更改，以及是否有費用差異。'
      },
      OOB: {
        tag: '超出服務範圍',
        tagType: 'policy',
        text: '感謝您的詢問！不過我是 VoyageAsia 的訂單客服助理，主要負責**已完成訂單**的相關問題。\n\n關於新訂房的推薦，您可以前往我們的官方網站瀏覽。如果您在訂單或退款方面有任何問題，我很樂意協助！'
      },
      UNCLEAR: {
        tag: '意圖不明確 → 釐清中',
        tagType: 'intent',
        text: '您好，我想確認一下我是否正確理解您的需求。\n\n請問您目前需要的是：\n① 查詢現有訂單的狀態\n② 更改或取消訂單\n③ 申請退款\n④ 其他問題\n\n請選擇或直接說明您的情況，我來幫您處理。'
      }
    };
    return responses[intent] || responses.UNCLEAR;
  }
};

function appendMsg(role, text, tag, tagType) {
  const window = document.getElementById('chatWindow');
  const msg = document.createElement('div');
  msg.className = 'chat-msg' + (role === 'user' ? ' user' : '');

  const avatar = document.createElement('div');
  avatar.className = 'chat-avatar' + (role === 'agent' ? ' agent' : '');
  avatar.textContent = role === 'agent' ? 'TB' : 'Me';

  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble ' + role;

  if (tag) {
    const tagEl = document.createElement('div');
    tagEl.className = 'chat-tag ' + (tagType || '');
    tagEl.textContent = tag;
    bubble.appendChild(tagEl);
  }

  const textEl = document.createElement('div');
  textEl.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  bubble.appendChild(textEl);

  msg.appendChild(avatar);
  msg.appendChild(bubble);
  window.appendChild(msg);
  window.scrollTop = window.scrollHeight;
}

function showTyping() {
  const window = document.getElementById('chatWindow');
  const typing = document.createElement('div');
  typing.className = 'chat-msg';
  typing.id = 'typingIndicator';
  typing.innerHTML = '<div class="chat-avatar agent">TB</div><div class="chat-bubble agent" style="color:var(--ink-faint);font-size:12px;">正在分析意圖...</div>';
  window.appendChild(typing);
  window.scrollTop = window.scrollHeight;
}

function removeTyping() {
  const t = document.getElementById('typingIndicator');
  if (t) t.remove();
}

function sendMessage() {
  const input = document.getElementById('simInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  processMessage(msg);
}

function sendScenario(msg) {
  processMessage(msg);
}

function processMessage(msg) {
  appendMsg('user', msg);
  document.getElementById('simStage').textContent = '分析中...';
  document.getElementById('simStage').classList.add('active');
  showTyping();

  setTimeout(() => {
    removeTyping();
    const intent = agentLogic.classify(msg);
    const resp = agentLogic.respond(intent, msg);
    appendMsg('agent', resp.text, resp.tag, resp.tagType);
    document.getElementById('simStage').textContent = intent;
  }, 900);
}

// COMPLETE
function markComplete() {
  const btn = document.getElementById('completeBtn');
  btn.classList.add('done');
  btn.textContent = 'Day 11 完成！';
  document.getElementById('completeNote').textContent = '繼續前往 Day 12：短租平台全棧設計 →';
}
</script>
</body>
</html>